<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jQuery UI Sortable - Display as grid</title>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://rawgithub.com/andris9/jStorage/master/jstorage.js"></script>
    <script src="https://rawgithub.com/documentcloud/underscore/master/underscore.js"></script>
    <script src="jqC/js/jquery-ui-1.10.1.js"></script>
    <link rel="stylesheet" href="http://meyerweb.com/eric/tools/css/reset/reset.css">
    <script src="jqC/js/jquery.slimscroll.js"></script>
    <link rel="stylesheet" href="playlist.css"/>
    <script src="SiteHandlers.js"></script>
    <script src="Utils.js"></script>
</head>
<body>
<div id="dPLists">
    <div id="firstView">
        <div id="ctrlFirst" class="ctrlFirst" style="height: 12%;">
            <label id="saveHistoryStatus" style="position:absolute">Status<br></label>
            <a style="position:relative; left: 27px; padding-right: 27px; " href="thisislink" id="nwWndFirst">Open in new window</a>
        </div>
        <div id="ulFirst" class="connectedSortable playlistFrame">
        </div>
    </div>

    <div id="secondView">
        <div id="ctrlSecond" class="ctrlSecond" style="height: 12%;">
            <a href="thisislink" id="nwWndSecond">Open in new window</a>
        </div>
        <div id="ulSecond" class="connectedSortable playlistFrame">
        </div>
    </div>

</div>
<script>
    function calendarSortedStringify(callback) {
        $.ajax({url:'/calendarSorted', success:function (data) {
            console.log(JSON.stringify(data))
            typeof callback == "function" && callback(data)
        }})
    }

    function calendarSorted(callback) {
        $.ajax({url:'/calendarSorted', success:function (data) {
            console.log(data)
            typeof callback == "function" && callback(data)
        }})
    }



    var pll = new Playlist("#ulFirst")
    var plr = new Playlist('#ulSecond');
    var saveToHistory = _.once(function() {
        var now = new Date().getTime();
        var user = 'sichain'
        var data = new Object();
        pll.immediateRecalculatePlaylist()
        data.data = pll.playlistVideos()
        var count = data.data.length
        data.meta = {user: user, url: window.location.href.replace(/.*\?location=([^#]+).*/, '$1'), date: now}
        console.log(JSON.stringify(data))
        $.ajax({
            url: '/calendar?date=' + now + '&user=' + user,
            type: 'post',
            data: JSON.stringify(data),
            success: function() {
                var saveHistoryElement = $('#saveHistoryStatus');
                saveHistoryElement.text(count)
                saveHistoryElement.css('font-size', 25)
                saveHistoryElement.css('background-color', 'green')
            },
            error: function(err) {
                console.log(err)
                alert('error in saving to history, please check console for further information')
            }
        })
    }.bind(this))
    pll.addSongsToPlaylist(pll.parseSongIds(window.location.hash), true, saveToHistory)

</script>
<script>
    var ctrlFirst = $('#ctrlFirst')
    var ctrlSecond = $('#ctrlSecond')
    var videos = function(elementExpression) {
        return $(elementExpression + " > div").map(function(index, div) { return $(div).data("videoFeed") } ).map(function(index, item) { return {type: item.type, id: item.id } }).toArray()
    }
    var videoIds = function(elementExpression) {
        return $(elementExpression).sortable('toArray').join(',')
    }

    var generateHref = function (elementExpression, containerElementExpression) {
        var proceed = $(elementExpression)
        proceed.attr("target", "_blank")
        proceed.css("font-size", "medium")
        proceed.click(function () {
            proceed.attr("href", "/display-grid.html#" + videoIds(containerElementExpression))
            setTimeout(function () {
                window.close()
            }, 10000)
        })
    }
    $(document).ready(function () {
        setSlimScroll("#ulFirst", "93.5%")
        setSlimScroll("#ulSecond", "93.5%")

        var drawSelectDifferences = function(ctrl, firstPlt, secondPlt) {
            var input = $('<input type="button"/>')
            input.val('Select differences')
            ctrl.append(input)
            input.click(function() {
                selectDifferences(firstPlt, secondPlt)
            })
        }

        var selectDifferences = function(firstPlt, secondPlt) {
            var differences = _.difference(firstPlt.sortable('toArray'), secondPlt.sortable('toArray'))
            firstPlt.find('>div').removeClass('ui-selected')
            _.each(differences, function(item) {
                firstPlt.find('#' + item.replace(/([=/])/g, '\\$1')).addClass('ui-selected')
            })
        }

        var drawPlaylist = function(plt, ctrl, playlistName, lReturnPlaylist) {
            var input = $('<input type="button"/>')
            input.val(playlistName)
            input.click(function () {
                console.log(plt.jPlaylist)
                plt.setId(playlistName)
            })
            ctrl.append(input)
        }

        $.jStorage.subscribe('windowIds', function(channel, payload) {
//            console.log($.jStorage.get(payload))
            if(!($('input[value=' + payload + ']').size())) {
                var returnPlaylist = function() {
                    console.log(payload)
                    return $.jStorage.get(payload).join(',')
                }
                drawPlaylist(pll, ctrlFirst, payload, returnPlaylist)
                drawPlaylist(plr, ctrlSecond, payload, returnPlaylist)
            }
        })

        drawSelectDifferences(ctrlFirst, pll.jPlaylist, plr.jPlaylist)
        drawSelectDifferences(ctrlSecond, plr.jPlaylist, pll.jPlaylist)

        drawPlaylist(pll, ctrlFirst, 'parsed', function () {
            return window.location.hash
        })

        $.jStorage.publish('queryWindowIds', 'give me');
        setInterval(function() {
            $.jStorage.publish('queryWindowIds', 'give me');
        }, 3000)

        generateHref("#nwWndFirst", "#ulFirst")
        generateHref("#nwWndSecond", "#ulSecond")
    })
</script>
</body>
</html>
