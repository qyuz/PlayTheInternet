<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Play The Internet</title>
    <LINK REL="SHORTCUT ICON" HREF="favicon.ico" />
    <!--<script src="jqC/development-bundle/jquery-1.7.1.js"></script>-->
    <!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.js"></script>-->
    <!--<script src="jqC/development-bundle/ui/jquery.ui.core.js"></script>-->
    <!--<script src="jqC/development-bundle/ui/jquery.ui.widget.js"></script>-->
    <!--<script src="jqC/development-bundle/ui/jquery.ui.mouse.js"></script>-->
    <!--<script src="jqC/development-bundle/ui/jquery.ui.sortable.js"></script>-->
    <!--<script src="jqC/development-bundle/ui/jquery.ui.position.js"></script>-->

    <!--<link rel="stylesheet" href="http://meyerweb.com/eric/tools/css/reset/reset.css">-->

    <!--<link rel="stylesheet" href="jqC/development-bundle/themes/base/jquery.ui.all.css">-->
    <!--<link rel="stylesheet" href="jqC/development-bundle/demos/demos.css">-->
    <!--<link rel="stylesheet" href="bootstrapCustom/css/bootstrap.css">    -->
    <!--<link rel="stylesheet" href="http://bootswatch.com/cosmo/bootstrap.css">-->
    <link rel="stylesheet" href="bootswatch/cosmo.css">
    <!--<link rel="stylesheet" href="https://rawgithub.com/eternicode/bootstrap-datepicker/master/css/datepicker.css">-->
    <link rel="stylesheet" href="datepicker.css">
    <!--<link rel="stylesheet" href="https://rawgithub.com/littlesparkvt/flatstrap/master/assets/css/bootstrap.css">-->
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="jqC/js/jquery-ui-1.10.1.js"></script>
    <!--<script src="bootstrap/js/bootstrap.js"></script>-->
    <!--<script src="https://rawgithub.com/eternicode/bootstrap-datepicker/master/js/bootstrap-datepicker.js"></script>-->
    <script src="bootstrap-datepicker.js"></script>
    <script src="https://rawgithub.com/andris9/jStorage/master/jstorage.js"></script>
    <script src="https://rawgithub.com/diy/intercom.js/master/intercom.js"></script>
    <script src="bootstrapCustom/js/bootstrap.js"></script>
    <script src="https://rawgithub.com/documentcloud/underscore/master/underscore.js"></script>
    <!--<script src="js/jqui1.10.3/jquery-ui-1.10.3.custom.min.js"></script>-->
    <script src="SiteHandlers.js"></script>
    <script src="Utils.js"></script>
    <script src="parse.js"></script>
    <!--<script type="text/javascript" src="swfobject.js"></script>-->
    <script src="https://w.soundcloud.com/player/api.js" type="text/javascript"></script>
    <script src="http://a.vimeocdn.com/js/froogaloop2.min.js" type="text/javascript"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="jqC/js/jquery.slimscroll.js"></script>
    <script src="http://jeromeetienne.github.io/jquery-qrcode/src/jquery.qrcode.js"></script>
    <script src="http://jeromeetienne.github.io/jquery-qrcode/src/qrcode.js"></script>
    <link rel="stylesheet" href="playlist.css">
    <style>
        .nav-pills > li > a {
            margin-right: 0px;
            margin-bottom: 0px;
            margin-top: 0px;
            color: #007fff;
        }
        .nav-pills > li > a:focus {
            background-color: #FFFFFF;
        }

        .nav > .active > a, .nav > .active > a > div, .nav > .active > a:hover, .nav > .active > a:hover > div{
            outline:none;
        }

        .nav-pills > .active > a > div, .nav-pills > .active > a:hover > div {
            color: #ffffff;
            background-color: #007fff;
        }

        .nav-pills > li > a:hover, .nav-pills > li > a:hover > div  {
            background-color: #d4fff7;
            color: #007fff;
        }
    </style>
    <script>

    </script>
</head>
<body>
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38758747-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>
<div id="dPLists">
    <div id="firstView">
        <div id="tabs" class="playlistFrame">
            <ul style="height: 0px;" class="nav nav-pills">
                <li class="active"><a href="#player">Player<div id="podPlayer" style="position: fixed; z-index: -1; left: 0px; width: 65px;"></div></a></li>
                <li><a href="#tAreaDiv">Text Area<div id="podTa" style="position: fixed; z-index: -1; left: 65px; width: 87px;"></div></a></li>
                <li><a href="#optionsDiv">Options<div id="podOptions" style="position: fixed; z-index: -1; left: 152px; width: 77px;"></div></a></li>
                <li><a href="#recycleBinDiv">Bin<div id="podBin" style="position: fixed; z-index: -1; left: 229px; width: 46px;"></div></a></li>
                <li><a href="#calendarDiv">Calendar<div id="podCalendar" style="position: fixed; z-index: -1; left: 229px; width: 46px;"></div></a></li>
            </ul>
            <div id="player">
            </div>
            <div id="tAreaDiv">
                <textArea id="tArea" class="taArea"></textArea>
                <br>
                <input id="tAreaParseButton" type="button" value="Parse text and add to playlist"/>
            </div>
            <div id="optionsDiv" class="playlistFrame">
                <fieldset>
                    <legend>Share this link</legend>
                    <input id="buildHash" type="button" value="Build link"/>
                    <br>
                    <input id="buildHashInput" class="max-width" type="text"/>
                </fieldset>
                <fieldset>
                    <legend>Rename window</legend>
                    <input id="renameWindow" type="button" value="Rename window"/>
                    <br>
                    <input id="renameWindowInput" class="max-width" type="text"/>
                </fieldset>
                <fieldset>
                    <legend>Go mobile</legend>
                    <div style="position: absolute; left: 30px" id="qrcode"></div>
                </fieldset>
            </div>
            <div id="recycleBinDiv" class="playlistFrame">
                <div id="ulFirst" class="connectedSortable playlistFrame"></div>
            </div>
            <div id="calendarDiv" class="playlistFrame">
                <div class="input-daterange">
                    <input class="input-small datepicker" name="start" id="calendarStart" data-date-format="dd-mm-yyyy"/>
                    <span class="add-on">to</span>
                    <input class="input-small datepicker" name="end" id="calendarEnd" data-date-format="dd-mm-yyyy"/>
                    <button id="searchCalendar" class="btn" type="button">Search</button>
                </div>
                <div id="calendarFilter" class="input-append">
                    <span class="add-on">Title</span>
                    <input class="input-small" id="calendarFilterTitle">
                    <span class="add-on">More than</span>
                    <input class="input-small" id="calendarFilterDurationMore">
                    <span class="add-on">Less than</span>
                    <input class="input-small" id="calendarFilterDurationLess">
                </div>
                <div id="calendarPlaylist" class="connectedSortable playlistFrame"></div>
            </div>
            <!--<div id="taFirst" class="playlistFrame internalFrame">-->
            <!--</div>-->
            <div id="players" class="playlistFrame">
                <div id="soundCloudContainer" class="playlistFrame" style="width: 0%">
                    <div id="soundCloud">
                        <iframe id="sc-widget"
                                src="https://w.soundcloud.com/player/?url=https://soundcloud.com/timelock/timelock-ace-ventura-inside-us"
                                width="100%" height="465" scrolling="no" frameborder="no">
                        </iframe>
                    </div>
                </div>
                <div id="youtubeContainer" class="playlistFrame" style="width: 100%">
                    <div id="youtube"></div>
                </div>
                <div id="vimeoContainer" class="playlistFrame" style="width: 0%">
                </div>
            </div>
        </div>
    </div>

    <div id="secondView">
        <div id="ulSecond" class="connectedSortable playlistFrame"></div>
    </div>

</div>

<script>
    var onceLoaded = _.once(function() {
        playlist.playVideoDiv(playlist.lookupNextSong())
    })
    var playFirstLoaded = _.after(3, function() {
        console.log('playFirstLoaded')
        onceLoaded()
    })

var gimpedAnimation = [
    {nav:"#player", fixed:"#podPlayer"},
    {nav:"#tAreaDiv", fixed:"#podTa"},
    {nav:"#optionsDiv", fixed:"#podOptions"},
    {nav:"#recycleBinDiv", fixed:"#podBin"}
]

fc = 220

$.each(gimpedAnimation, function (index, item) {
    var rgb = function (number) {
        console.log(number)
        return 'rgb(' + number + ', ' + number + ', ' + number + ')'
    }
    $('a[href="' + item.nav + '"]').mouseenter(function (event, ui) {
        $(item.fixed).animate({height:"100%"}, { queue:false, duration:500})
    }).mouseleave(function (event, ui) {
                $(item.fixed).animate({
                    height:"0%"
                }, 600, 'linear', function () {
                    $('a[href="' + item.nav + '"]').removeClass('post-hover')
                });
                $(item.fixed).addClass('post-hover')
                $('a[href="' + item.nav + '"]').addClass('post-hover')
            });
})

    $(document).ready(function () {
        window.windowId = GUID()
        $.jStorage.subscribe('queryWindowIds', function(message) {
//        console.log(message)
            $.jStorage.publish('windowIds', windowId)
        })
//    var yt1 = new YoutubePlayer(null, new Playlist("#ulFirst"))
        $.jStorage.set(windowId, window.location.hash.replace(/.*#(.*)/, '$1').split(','))
        window.ulFirst = new Playlist('#ulFirst')
        window.calendarPlaylist = new Playlist('#calendarPlaylist', {type: 'calendar'})
        window.playlist = new Playlist("#ulSecond",
                {
                    id: windowId,
                    listenKeyChangeCallback: function(playlist) {
                        window.location.hash = playlist.jPlaylist.sortable('toArray')
                        $('#qrcode').empty()
                        $('#qrcode').qrcode(window.location.href)
                    }
                });
        playlist.addSongsToPlaylist(playlist.parseSongIds(window.location.hash), true)

        setSlimScroll('#calendarPlaylist', "100%")
        setSlimScroll('#ulFirst', "100%")
        setSlimScroll('#ulSecond', "100%")
        $('.datepicker').datepicker()
        $('#searchCalendar').click(function(evt) {
            propagateCalendar()
        })
        $('#tAreaParseButton').click(function() {
            var tAreaText = $('#tArea').val()
            playlist.addSongsToPlaylist(playlist.parseSongIds(playTheInternetParse(tAreaText)), true)
        })
        $('#buildHash').click(function() {
            $('#buildHashInput').val(window.location.origin + '/display-grid.html'+ playlist.buildHash())
        })
        $('#renameWindow').click(function() {
            var renameWindowInputVal = $('#renameWindowInput').val();
            if (renameWindowInputVal.length > 0) {
                document.title = document.title.replace(windowId, renameWindowInputVal)
                windowId = renameWindowInputVal
                IntercomWrapper(windowId)
            }
        })

        IntercomWrapper(windowId)

        if (window.location.hash.length == 0) {
            $( "#tabs" ).tabs( "option", "active", 1 );
        }
        var filterThrottle = _.throttle(function() {
            matchTitleRegExp = new RegExp($('#calendarFilterTitle').val(), "gi")
            filterDurationMoreValue = $('#calendarFilterDurationMore').val()
            filterDurationLessValue = $('#calendarFilterDurationLess').val()
            select()
        }, 1500)
        $('#calendarFilter').keyup(filterThrottle)

        document.title = windowId
    })

    var scWidgetIframe = document.getElementById('sc-widget');
    window.scWidget = SC.Widget(scWidgetIframe);

    scWidget.bind(SC.Widget.Events.READY, function () {
        console.log('playFirstLoaded sc')
        playFirstLoaded();
        scWidget.bind(SC.Widget.Events.FINISH, function () {
            scWidget.getCurrentSoundIndex(function (data) {
                scWidget.getSounds(function (sounds) {
                    console.log('finished sounds count: ' + sounds.length + ' and current index: ' + data)
                    if (data == sounds.length - 1) {
                        SiteHandlerManager.prototype.stateChange("NEXT")
                    }
                })
            })
        })
    });

    function onYouTubeIframeAPIReady() {
        window.youtube = new YT.Player('youtube', {
            height: '100%',
            width: '100%',
            videoId: 'MK6TXMsvgQg',
            events: {
                'onReady': onPlayerReady,
                'onStateChange': change,
                'onError': onError
            }
        });
    }

    function onPlayerReady(event) {
        $('#ulFirst, #ulSecond').click(function(evt) {
            playlist.playVideoDiv($(evt.target).closest('div[class*="pti-state-default"]'))
        })
        console.log('playFirstLoaded yt')
        playFirstLoaded();
    }

    function change(state) {
        console.log(state)
        if(state.data == 0) {
            SiteHandlerManager.prototype.stateChange("NEXT")
        }
    }

    function onError() {
        SiteHandlerManager.prototype.stateChange("ERROR")
    }

    function propagateCalendar() {
        var dateRange = ""
        if($('#calendarStart').val()) {
            dateRange += "start=" + DPGlobal.parseDate($('#calendarStart').val(), DPGlobal.parseFormat('dd-mm-yyyy')).getTime() + "&"
        }
        if($('#calendarEnd').val()) {
            dateRange += "end=" + (DPGlobal.parseDate($('#calendarEnd').val(), DPGlobal.parseFormat('dd-mm-yyyy')).getTime() + 86399999)
        }
        console.log(dateRange)
        $.ajax({
            url: '/calendarSorted?' + dateRange,
            success: function(data) {
//                var uniqSongs = _.uniq(_.flatten(_.reduce(data, function (memo, item) {
//                    memo.push(item.data);
//                    return memo
//                }, new Array())), function (item) {
//                    return item.type + '=' + item.id
//                })
////                console.log(uniqSongs)
//                var compose = _.compose(map, _.pairs, groupByDate, reduce)
                var compose = _.compose(map, _.pairs, groupByUrl, reduce)
                var calendarDays = compose(data)
                calendarPlaylist.jPlaylist.empty()
                calendarPlaylist.addCalendarSongsToPlaylist(calendarDays)
            }
        })
    }

    $('#tabs').tabs({
        activate: function( event, ui ) {
            var newTab = $(ui.newTab);
            console.log(newTab.text())
//            if(newTab.text() == "Calendar") {
//                propagateCalendar()
//            }
            newTab.addClass('active')
            $(ui.oldTab).removeClass('active')
        }
    })

    var matchTitleRegExp
    var matchText = function (node) {
        return $(node).text().match(matchTitleRegExp) != null ? true : false
    }
    var selectMatched = function (node, matchNode) {
        var jNode = $(node)
        if (matchNode(node)) {
            calendarPlaylist.jPlaylist.append(jNode)
            jNode.addClass('ui-selected')
        } else {
            jNode.removeClass('ui-selected')
        }
    }
    var select = function () {
        calendarPlaylist.jPlaylist.find('>*').remove(null, true)
        _.each(calendarPlaylist.playlist, function (item) {
            selectMatched(item, filters)
        })
    }

    var filters = function(node) {
        var result = true
        if(result && matchTitleRegExp.toString() != "\"/(?:)/gi\"") {
            result = filterTitle(node)
        }
        if(result && filterDurationMoreValue != "NaN") {
            result = filterDurationMore(node)
        }
        if(result && filterDurationLessValue > 0 && filterDurationLessValue != "NaN") {
            result = filterDurationLess(node)
        }
        return result
    }

    var filterTitle = function(node) {
        node = $(node)
        var data = node.data('videoFeed')
        var title = data.title || data.id
        return title.match(matchTitleRegExp) ? true : false
    }
    var filterDurationMore = function(node) {
        node = $(node)
        var data = node.data('videoFeed')
        if(data.duration == undefined) {
            return true
        }
        return data && data.duration && data.duration >= filterDurationMoreValue ? true : false
    }
    var filterDurationLess = function(node) {
        node = $(node)
        var data = node.data('videoFeed')
        if(data.duration == undefined) {
            return true
        }
        return data && data.duration && data.duration <= filterDurationLessValue ? true : false
    }
        window.regEx = /(((\d+)([d:\s]*))?((\d+)([h:\s]*))?)?((\d+)([m:\s]*))?(\d+)([s\s]*)/
    var stringToSeconds = function(string) {
        var result = string.match(regEx)
        console.log(result)
        if(result) {
            var day = result[2] != undefined ? Number(result[2]) : 0
            var hour = result[5] != undefined ? Number(result[5]) : 0
            var minutes = result[8] != undefined ? Number(result[8]) : 0
            var seconds = result[10] != undefined ? Number(result[10]) : 0
            console.log({day: day, hour: hour, minutes: minutes, seconds: seconds})
            return day * 86400 + hour * 3600 + minutes * 60 + seconds
        } else {
            return 0
        }
    }

</script>
</body>
</html>
