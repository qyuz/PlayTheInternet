<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jQuery UI Sortable - Display as grid</title>
    <!--<script src="js/datajs.js"></script>-->
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://raw.github.com/andris9/jStorage/master/jstorage.js"></script>
    <script src="https://raw.github.com/documentcloud/underscore/master/underscore.js"></script>
    <script src="jqC/js/jquery-ui-1.10.1.js"></script>
    <script src="jqC/js/jquery.slimscroll.js"></script>
    <link rel="stylesheet" href="playlist.css"/>
    <link rel="stylesheet" href="jqC/development-bundle/demos/demos.css">
    <link rel="stylesheet" href="jqC/development-bundle/themes/base/jquery.ui.all.css">
    <script src="SiteHandlers.js"></script>
    <script src="Utils.js"></script>
    <style>
        .parsePlaylistFrame {  float: left; width: 100%; height: 87%; overflow-x: hidden; overflow-y: hidden;  }
    </style>
</head>
<body>
<!--<a id="proceed" href="" target="_blank">Open in new Window</a>    <br>-->
<!--<a id="addChannel">Add to current Playlist</a>-->
<div id="dPLists">
    <div id="firstView">
        <div id="ctrlFirst" class="ctrlFirst" style="height: 12%;">
            <a href="thisislink" id="nwWndFirst">Open in new window</a>
        </div>
        <div id="ulFirst" class="connectedSortable parsePlaylistFrame">
        </div>
    </div>

    <div id="secondView">
        <div id="ctrlSecond" class="ctrlSecond" style="height: 12%;">
            <a href="thisislink" id="nwWndSecond">Open in new window</a>
        </div>
        <div id="ulSecond" class="connectedSortable parsePlaylistFrame">
        </div>
    </div>

</div>
<script>
//    $("#ulFirst, #ulSecond").sortable({
//        connectWith:'.connectedSortable',
//        scrollSensitivity:50,
//        tolerance:'pointer',
//        distance:25,
//        update:function (event, ui) {
//            pll.recalculatePlaylist()
//            plr.recalculatePlaylist()
//        }
//    })
    var pll = new Playlist("#ulFirst")
    var plr = new Playlist('#ulSecond');
    pll.addSongsToPlaylist(pll.parseSongIds(window.location.hash))

</script>
<script>
    var ctrlFirst = $('#ctrlFirst')
    var ctrlSecond = $('#ctrlSecond')
    var videos = function(elementExpression) {
        return $(elementExpression + " > div").map(function(index, div) { return $(div).data("videoFeed") } ).map(function(index, item) { return {type: item.type, id: item.id } }).toArray()
    }
    var videoIds = function(elementExpression) {
        var ids = ""
        $(elementExpression + ' > div').each(function (index, item) {
            videoFeed = $(item).data('videoFeed')
            if (videoFeed) {
                ids += videoFeed.type + '=' + videoFeed.id + ','
            }
        })
        return ids
    }

    var generateHref = function (elementExpression, containerElementExpression) {
        var proceed = $(elementExpression)
        proceed.attr("target", "_blank")
        proceed.css("font-size", "medium")
        proceed.click(function () {
            proceed.attr("href", "/display-grid.html#" + videoIds(containerElementExpression))
            setTimeout(function () {
                window.close()
            }, 10000)
        })
    }
    $(document).ready(function () {
        setSlimScroll("#ulFirst", "93.5%")
        setSlimScroll("#ulSecond", "93.5%")

        var drawPlaylist = function(plt, ctrl, playlistName, lReturnPlaylist) {
            var input = $('<input type="button"/>')
            input.val(playlistName)
            input.click(function () {
                console.log(plt.jPlaylist)
                plt.setId(playlistName)
            })
            ctrl.append(input)
        }

        $.jStorage.subscribe('windowIds', function(channel, payload) {
            console.log($.jStorage.get(payload))
            if(!($('input[value=' + payload + ']').size())) {
                var returnPlaylist = function() {
                    console.log(payload)
                    return $.jStorage.get(payload).join(',')
                }
                drawPlaylist(pll, ctrlFirst, payload, returnPlaylist)
                drawPlaylist(plr, ctrlSecond, payload, returnPlaylist)
            }
        })

        drawPlaylist(pll, ctrlFirst, 'parsed', function () {
            return window.location.hash
        })

        $.jStorage.publish('queryWindowIds', 'give me');
        setInterval(function() {
//            $.jStorage.publish('queryWindowIds', 'give me');
        }, 2000)

        generateHref("#nwWndFirst", "#ulFirst")
        generateHref("#nwWndSecond", "#ulSecond")
    })
</script>
</body>
</html>
